---
layout: post
title: '[JavaScript] 자바스크립트 런타임'
featured-img: javascript/js.png
category: [tech, javaScript]
---
{% include toc.html %}

이번 포스트에서 이야기 할 [런타임(runtime)](https://ko.wikipedia.org/wiki/런타임)이란 프로그래밍 언어가 구동되는 환경을 말합니다.(위키 링크를 보면 런타임 환경이라고 보시면 될 것 같습니다.) Node.js나 크롬 등의 여러 브라우저들은 자바스크립트가 구동되는 환경이기 때문에, Node.js나 브라우저들을 자바스크립트 런타임이라고 합니다.

자바스크립트 런타임의 동작 원리를 이야기 하도록 하겠습니다.

# 싱글 스레드, 논-블로킹 언어: JavaScript
자바스크립트는 싱글 스레드, 논-블로킹 언어입니다. 싱글 스레드는 무엇인지, 논-블로킹은 무엇인지 알아 보도록 하겠습니다.

## 싱글 스레드
싱글 스레드란 하나의 콜스택을 가집니다. 하나의 콜스택을 가진다는 의미는 한번에 한가지 일 밖에 하지 못한다는 의미입니다. 예를 들어 네트워크 요청을 한다면, 응답이 올 때까지 다른 일은 하지 못하고 마냥 기다릴 수 밖에 없습니다.

## 콜스택
[콜스택](https://ko.wikipedia.org/wiki/콜_스택)은 함수가 실행되는 순서를 기억하고 있습니다. 함수를 실행하려면 스택의 가장 위에 해당 함수를 넣게 되고, 함수에서 리턴이 일어나면 스택의 가장 위쪽에서 함수를 꺼냅니다. 간단한 코드 예제를 살펴보도록 하겠습니다.

### 콜스택 예제
![콜스택](/assets/img/posts/javascript/call_stack.gif)

1. `main` 함수가 호출 되고, `multiply` 함수가 정의 됩니다.
2. `square` 함수가 정의됩니다.
3. `printSquare` 함수가 정의됩니다.
4. `printSquare(4)`를 호출합니다.
5. 콜스택에 `printSquare(4)`가 쌓입니다. 그리고 `square(n)`을 호출합니다.
6. 콜스택에 `square(n)`이 쌓입니다. 그리고 `multiply(n, n)`을 호출합니다.
7. 콜스택에 `multiply(n, n)`가 쌓입니다. 그리고 `a * b` 결과를 리턴합니다.
8. `multiply` 함수가 리턴되어, 콜스택에 `multiply(n, n)`가 제거 됩니다.
9. `square` 함수가 리턴되어, 콜스택에 `square(n)`이 제거 됩니다.
10. `console.log(square)`를 호출하여, 콜스택에 `console.log(square)`이 쌓입니다.
11. `console.log(square)`가 리턴되어, 콜스택에 `console.log(square)`가 제거됩니다.
12. `printSquare` 함수가 리턴되어, 콜스택에 `printSquare(4)`가 제거됩니다.

위의 순서로 콜스택이 동작합니다.

### 콜스택 에러 메세지
에러를 디버깅하면서 콜스택을 보셨을 것입니다.

![에러 콜스택](/assets/img/posts/javascript/error_call_stack.png)

위의 그림과 같이 에러가 발생했을 때, 어떤 함수에서 에러가 발생했는지 로그로 보여주는데, 에러 로그에 출력되는 것들이 콜스택의 값들입니다.

### 스택 오버플로우
스택이 가득차게 되면 에러가 발생하는데,

![에러 콜스택](/assets/img/posts/javascript/stack_overflow.png)

위의 코드와 같이 `Uncaught RangeError: Maxium call stack size exceeded` 라는 오류를 보셨을 것입니다. 에러 문구에서 알수 있듯이, 콜스택이 가득차서 발생하는 에러입니다.

## 논-블로킹
싱글 스레드는 한번에 한가지 일 밖에 할 수 없습니다. 예를 들어 네트워크 요청을 한다면, 응답이 올 때까지 다른 일은 하지 못하고 마냥 기다릴 수 밖에 없습니다.

이것이 왜 문제가 되느냐? 웹 브라우저에서 코드가 실행되는데, 코드가 종료될 때까지 유저가 클릭을 해도 어떠한 반응을 하지 않는 상태가 됩니다. 사용자에게 원활한 UI를 제공해야 한다면, 콜스택이 멈추게 해서는 안됩니다. 콜스택이 멈춘 상태를 블로킹 상태라고 이야기 하도록 하겠습니다.

![블로킹](/assets/img/posts/javascript/blocking.gif)

1. 
2. 
3. 
4. 
5. 
6. 
7. 
8. 
9. 
10. 
11. 
12. 
13. 
14. 
15. 
16. 

위의 그림과 같이 블로킹이 되면 사용자 화면의 버튼을 클릭해도 반응이 없는, 사용자와 인터랙션(interaction) 할 수 없는 상태가 됩니다. 이 블로킹 상태를 해결하는 방법은 논-블로킹, 비동기 콜백을 사용하는 것입니다.

![논-블로킹](/assets/img/posts/javascript/none_blocking.gif)

1. `main` 함수가 호출되어, 콜스택에 쌓습니다.
2. `console.log('hi')`를 호출하여, 콜스택에 쌓습니다.
3. `console.log`가 리턴되어 콜스택에서 제거된 후, `setTimeout` 함수가 호출되어 콜스택에 쌓입니다. 5초 타이머가 시작됩니다.
4. `setTimeout`가 리턴되어 콜스택에서 제거된 후, `console.log('JSConfEU')`가 호출되어 콜스택에 쌓입니다.
5. `console.log`가 리턴되어 콜스택에서 제거 됩니다.
6. `main` 함수가 리턴되어 콜스택에서 제거 됩니다.
7. 5초후 `setTimeout`의 콜백 함수가 실행됩니다.
8. `setTimeout`의 콜백 함수가 리턴되어 콜스택에서 제거됩니다.

위의 코드처럼 5초 동안 아무런 동작를 하지 못하는 것이 아니라, 5초후 호출되는 비동기 콜백으로 블로킹 문제를 해결할 수 있습니다. 어떻게 5초 후 `setTimeout`의 콜백 함수가 호출되는지는 아래의 내용에서 더 자세히 설명하도록 하겠습니다.

# 자바스크립트 런타임
싱글 스레드인 자바스크립트가 매번 5초가 지났는지 체크하지 않고, 5초 후에 콜백을 호출 할 수 있는 이유는 브라우저가 자바스크립트를 실행하는 것 이상의 의미를 가지기 때문입니다.

~~ 예제 사진 ~~

## V8 엔진
![V8 엔진 로고](/assets/img/posts/javascript/v8.svg){:.width25.aligncenter}

[V8](https://v8.dev/)는 구글에서 개발한 오픈소스 자바스크립트 엔진입니다. C++로 만들어져 있으며, Node.js, 크롬 브라우저 등에서 사용됩니다. V8은 싱글 스레드를 제공합니다. 싱글 스레드를 제공한다는 말은 간단히 하나의 콜스택(Call Stack)을 제공한다는 의미입니다.

setTimeout, HTTP 요청은 대표적인 비동기 동작들 하지막 V8 소스에는 이런 내용들이 없음

자바스크립트는 싱글 스레드 프로그래밍 언어, 싱글 스레드 런타임을 가지고 있음 즉 하나의 콜스택을 가지고 있음 쉽게 말하면 하나의 프로그램은 동시에 하나의 코드만 실행할 수 있다.

## 브라우저의 WEB API
DOM, ajax, timeout

## 콜백 큐 (테스크 큐)
Web API 결과 값을 쌓아 두는 큐

## 이벤트 루프
~~ 예제 사진 ~~

콜스택과 콜백 큐를 관찰하는 역할을 한다. 콜스택이 비어 있으면 큐의 첫번째 콜백을 스택에 쌓는다.

### 이벤트 루프 예시

#### setTimeout(..., 0)
setTimeout(..., 0)는 스택이 비어있을 때까지 기다리기 위해서이다.

~~ 예제 사진 ~~

#### ajax
ajax도 setTimeout과 동일하게 동작합니다.

~~ 예제 사진 ~~

#### setTimeout
~~ 예제 사진 ~~

setTimeout는 정확히 얼마 후 동작하겠다는 의미가 아니라 얼마 후 동작하는 최소 시간을 보장한다는 의미가 더 정확하다. 왜나하면 콜백이 정해진 시간 후 콜백 큐에 쌓이는데, 콜백 큐에 쌓인 콜백이 콜스택에 들어오기 위해서는 콜스택이 비어 있어야 하고, 정해진 시간이 지난 후 그 이후에 콜스택이 비어있을 때, setTimeout이 실행 된다.

## 렌더 큐
1초에 60프레임 속도로 화면을 다시 그립니다(Repaint). 하지만 자바스크립트가 하는 일들로 인해 repaint 작업에 영항을 받습니다. 렌더도 하나의 콜백처럼 동작하기 때문에, 스택에 코드가 있으면 렌더링하지 못합니다.

렌더 큐와 이벤트 큐의 차이점은 렌더 큐가 이벤트 큐보다 더 높은 우선순위를 가진다는 점입니다.

~~ 예시 사진 ~~

예를 들어 느린 동시식 루프를 실행하면, 콜스택에 코드가 쌓여있기 때문에 렌더가 동작하지 않습니다.

이벤트 루프를 막지 말라고 하는 것이 이러한 현상을 뜻합니다. 콜스택에 쓸데없는 느린 코드를 쌓아서 브라우저가 할 일(렌더링)을 못하게 하는 일이 없어야 합니다. 단위가 큰 코드는 작은 단위로 쪼개거나, 오래 걸리는 작업들은 비동기로 동작시키는 것이 좋습니다.

#### 참고
- [https://www.youtube.com/watch?v=8aGhZQkoFbQ](https://www.youtube.com/watch?v=8aGhZQkoFbQ)