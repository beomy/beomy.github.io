<html>
    <head>
        <script type="text/javascript" src="./js/jquery-1.12.1.js"></script>
        <script type="text/javascript" src="./js/axios.min.js"></script>
        <link href="./style/common.css" rel="stylesheet" />
    </head>
    <body>
        <header>
            <div class="log-area">
                <h1>Bridge 총회</h1>
            </div>
        </header>
        <nav class="vote-nav">
            <ul>
                <li class="on" voteType="1">회장</li>
                <li voteType="2">부회장</li>
            </ul>
        </nav>
        <p style="color:#fff; font-size:15px;">브릿지를 사랑하는 마음을 가득 담아...</p>
        <div class="container">
            <div class="list-area">
                <ul class="list-view"></ul>
            </div>
            <div class="total-vote-area">
                <span>총 투표 수 : </span><span id="total-vote">0</span>
            </div>
            <hr />
            <div class="input-area">
                <input id="name" type="text" />
                <button id="add-candidate">등록</button>
            </div>
        </div>
    </body>
    <script type="text/javascript">
        // var apiURL = 'http://localhost:5000';
        var apiURL = 'https://apibeomy.herokuapp.com';

        function calculateTotalVote() {
            var $voteCount = $(document).find('.vote-count');
            var totalCount = 0;
            for(var key = 0; key < $voteCount.length; key++) {
                var $item = $($voteCount[key]);
                totalCount += Number($item.val());
            }
            $("#total-vote").text(totalCount);
        }

        function getCandidateHtml(data) {
            var html = '';
            html += '<li class="candidate-list">';
            html += '    <span class="candidate-name">' + data.name + '</span> <input class="vote-count" type="number" value="' + data.vote + '" />';
            html += '    <button class="vote-btn add-vote">+</button><button class="vote-btn sub-vote">-</button>';
            html += '    <button class="vote-btn remove-candidate">x</button>';
            html += '</li>';
            return html;
        }

        function drawCandidate(voteType) {
            axios({
                method: 'get',
                url: apiURL + '/vote/candidateList'
            }).then(function (result) {
                candidateList = result.data;
                var list = candidateList.filter(function(item) {
                    var type = item.type;
                    if (type === voteType)
                        return true;
                    else
                        return false;
                });

                $(".list-view").html('');
                for (var key = 0; key < list.length; key++) {
                    var item = list[key];
                    var html = getCandidateHtml(item);
                    $(".list-view").append(html);
                }
                calculateTotalVote();
            }).catch(function (e) {
            });
        }

        function addCandidate(name, voteType) {
            axios({
                method: 'post',
                url: apiURL + '/vote/addCandidate',
                data: {
                    name: name,
                    voteType: voteType
                }
            }).then(function (result) {
            }).catch(function (e) {
            });            
        }

        function removeCandidate(name, voteType) {
            axios({
                method: 'post',
                url: apiURL + '/vote/removeCandidate',
                data: {
                    name: name,
                    voteType: voteType
                }
            }).then(function (result) {
            }).catch(function (e) {
            });            
        }

        function updateVote(name, voteType, vote) {
            axios({
                method: 'post',
                url: apiURL + '/vote/updateVote',
                data: {
                    name: name,
                    voteType: voteType,
                    vote: vote
                }
            }).then(function (result) {
            }).catch(function (e) {
            });            
        }

        $(document).ready(function () {
            var candidateList = [];
            var voteType = 1;
            drawCandidate(voteType);

            $('.vote-nav li').on('click', function () {
                voteType = $(this).attr('voteType');
                $('.on').removeClass('on');
                $(this).addClass('on');
                drawCandidate(Number(voteType));
            });

            $('#add-candidate').on('click', function () {
                var name = $('#name').val();
                var html = getCandidateHtml({name: name, vote: 0});
                addCandidate(name, voteType);
                $(".list-view").append(html);
            });

            $(document).on('click', '.remove-candidate', function () {
                var $removeCandidate = $(this).parent();
                var name = $removeCandidate.find('.candidate-name').text();
                $removeCandidate.remove();
                removeCandidate(name, voteType);
                calculateTotalVote();
            });

            $(document).on('click', '.add-vote', function () {
                var $target = $(this).parent();
                var $targetVoteCount = $target.find('.vote-count');
                var name = $target.find('.candidate-name').text();
                var vote = Number($targetVoteCount.val()) + 1;

                $targetVoteCount.val(vote);
                updateVote(name, voteType, vote);
                calculateTotalVote();
                $targetVoteCount.focus();
            });

            $(document).on('click', '.sub-vote', function () {
                var $target = $(this).parent();
                var $targetVoteCount = $target.find('.vote-count');
                var name = $target.find('.candidate-name').text();
                var vote = Number($targetVoteCount.val()) - 1;
                
                if (Number($targetVoteCount.val()) === 0) return;

                $targetVoteCount.val(vote);
                updateVote(name, voteType, vote);
                calculateTotalVote();
                $targetVoteCount.focus();
            });
        });
    </script>
</html>